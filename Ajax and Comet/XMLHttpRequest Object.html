<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>cross-browser XMLHttpRequest Object</title>
</head>
<body>
	<script type="text/javascript">
		function createXHR(){
			//检测原生XHR对象是否存在
			if (typeof XMLHttpRequest != "undefined") {
				return new XMLHttpRequest();
				//检测ie ActiveXObject对象
			}else if (typeof ActiveXObject != "undefined") {
				if(typeof arguments.callee.activeXString != "string"){
					//ie中三个不同版本的XHR对象
					var versions = ["MSXML2.XMLHttp.6.0", "MSXML2.XMLHttp.3.0", "MSXML2.XMLHttp"],
						i,len;

					for(var i = 0, len = versions.length; i < len; i++){
						try{
							new ActiveXObject(versions[i]);
							arguments.callee.activeXString = versions[i];
							break;
						}catch (ex){
							//跳过
						}
					}
				}

				return new ActiveXObject(arguments.callee.activeXString);
			}else {
				throw new Error("No XHR object available.");
			}
		}

		//创建XHR对象
		var xhr = createXHR();
		xhr.onreadystatechange = function(){
			if(xhr.readyState == 4){
				if((xhr.status >= 200 && xhr.status < 300) || xhr.status == 304){
					console.log(xhr.responseText);
				}else {
					console.log("Request was unsuccessful: " + xhr.status);
				}
			}
		};
		xhr.open("get", "exmple.php", true);
		//自定义请求头部信息
		xhr.setRequestHeader("MyHeader", "MyValue");
		xhr.send(null);
		//取消异步请求
		// xhr.abort();

		//get 请求
		//编码url
		function addURLParam(url, name, value){
			url += (url.indexOf("?") == -1 ? "?" : "&");
			url += encodeURIComponent(name) + "=" + encodeURIComponent(value);
			return url;
		}

		var url = "example.php";

		url = addURLParam(url, "name", "Chris");
		url = addURLParam(url, "book", "Professional JavaScript");

		//跨浏览器的CORS
		function createCORSRequest(method, url){
			var xhr = new XMLHttpRequest();
			if ("withCredentials" in xhr) {
				xhr.open(method, url, true);
			}else if (typeof XDomainRequest != "undefined") {
				xhr = new XDomainRequest();
				xhr.open(method, url);
			}else {
				xhr = null;
			}
			return xhr;
		}

		var request = createCORSRequest("get", "http://www.somewhere-else.com/page/");
		if (request) {
			request.onload = function(){
				//对request.responseText进行处理
			};
			request.send();
		}

		//其他跨域技术

		//图像Ping
		var img = new Image();
		img.onload = img.onerror = function(){
			console.log("Done");
		};
		img.src = "http://www.example.com/test?name=Nicholas";

		//JSONP(JSON with padding)
		callback({"name": "Chris"});

		function handleResponse(response){
			console.log("You're at IP address " + response.ip + ", which is in " + response.city + ", " + response.region_name);
		}

		var script = document.createElement("script");
		script.src = "http://freegeoip.net/json/?callback=handleResponse";
		document.body.insertBefore(script, document.body.firstChild);

		//Comet
		//使用XHR对象实现HTTP流 典型代码
		function createStreamingClient(url, progress, finished){

			var xhr = new XMLHttpRequest(),
				received = 0;
			xhr.open("get", url, true);
			xhr.onreadystatechange = function(){
				var result;

				if (xhr.readyState == 3) {

					//只取得最新数据并调整计数器
					result = xhr.responseText.substring(received);
					received += result.length;

					//调用progress回调函数
					progress(result);

				}else if (xhr.readyState == 4) {
					finished(xhr.responseText);
				}
			};
			xhr.send(null);
			return xhr;
		}

		var client = createStreamingClient("streaming.php", function(data){
				console.log("Received: " + data);
			}, function (data){
				console.log("Done!");
			});

	</script>
</body>
</html>